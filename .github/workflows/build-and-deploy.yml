name: Build and Deploy to Nexus

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  MAVEN_OPTS: '-Xmx1024m'
  REGISTRY: ${{ secrets.NEXUS_DOCKER_REGISTRY }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      java-version: ${{ steps.java-version.outputs.java-version }}
      group-id: ${{ steps.version.outputs.group_id }}
      artifact-id: ${{ steps.version.outputs.artifact_id }}
      current-version: ${{ steps.version.outputs.current_version }}
      release-version: ${{ steps.version.outputs.release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract Java version from pom.xml
        id: java-version
        run: |
          JAVA_VERSION=$(grep -A 5 '<properties>' pom.xml | grep '<java.version>' | sed 's/.*<java.version>\(.*\)<\/java.version>.*/\1/' | xargs)
          echo "Extracted Java version: $JAVA_VERSION"
          echo "java-version=$JAVA_VERSION" >> $GITHUB_OUTPUT

      - name: Set up JDK ${{ steps.java-version.outputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ steps.java-version.outputs.java-version }}
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Extract and prepare version information
        id: version
        run: |
          chmod +x ./mvnw
          
          echo "Attempting to extract project information from pom.xml..."
          
          if CURRENT_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null) && \
             GROUP_ID=$(./mvnw help:evaluate -Dexpression=project.groupId -q -DforceStdout 2>/dev/null) && \
             ARTIFACT_ID=$(./mvnw help:evaluate -Dexpression=project.artifactId -q -DforceStdout 2>/dev/null); then
            echo "‚úÖ Project info extracted using Maven wrapper:"
            echo "  GroupId: $GROUP_ID"
            echo "  ArtifactId: $ARTIFACT_ID" 
            echo "  Version: $CURRENT_VERSION"
          else
            echo "‚ö†Ô∏è Maven wrapper failed, trying alternative methods..."
            CURRENT_VERSION=$(grep -A 10 '<artifactId>helloworlddb</artifactId>' pom.xml | grep '<version>' | head -1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | xargs)
            GROUP_ID=$(grep -A 5 '<artifactId>helloworlddb</artifactId>' pom.xml | grep -B 5 '<version>' | grep '<groupId>' | sed 's/.*<groupId>\(.*\)<\/groupId>.*/\1/' | xargs)
            ARTIFACT_ID=$(grep '<artifactId>helloworlddb</artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/' | xargs)
            echo "‚úÖ Project info extracted from pom.xml:"
            echo "  GroupId: $GROUP_ID"
            echo "  ArtifactId: $ARTIFACT_ID"
            echo "  Version: $CURRENT_VERSION"
          fi
          
          if [[ -z "$GROUP_ID" || -z "$ARTIFACT_ID" ]]; then
            echo "‚ùå Failed to extract groupId or artifactId"
            exit 1
          fi
          
          if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?$ ]]; then
            echo "‚ùå Invalid version format: $CURRENT_VERSION"
            echo "Setting default version: 0.0.1-SNAPSHOT"
            CURRENT_VERSION="0.0.1-SNAPSHOT"
          fi
          
          echo "group_id=$GROUP_ID" >> $GITHUB_OUTPUT
          echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//')
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

          # Get the latest git tag to determine next version
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=$(echo $LATEST_TAG | sed 's/^v//')
          
          echo "Latest git tag: $LATEST_TAG"
          echo "Latest version: $LATEST_VERSION"

          # Parse latest version
          if [[ "$LATEST_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            MAJOR=$(echo $LATEST_VERSION | cut -d. -f1)
            MINOR=$(echo $LATEST_VERSION | cut -d. -f2)
            PATCH=$(echo $LATEST_VERSION | cut -d. -f3)
          
            NEW_PATCH=$((PATCH + 1))
            RELEASE_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          else
            # If no valid tag exists, use base version from pom.xml
            MAJOR=$(echo $BASE_VERSION | cut -d. -f1)
            MINOR=$(echo $BASE_VERSION | cut -d. -f2)
            PATCH=$(echo $BASE_VERSION | cut -d. -f3)
            RELEASE_VERSION="$MAJOR.$MINOR.$PATCH"
          fi

          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

          echo "üìã Project Summary:"
          echo "  GroupId: $GROUP_ID"
          echo "  ArtifactId: $ARTIFACT_ID"
          echo "  Current SNAPSHOT version: $CURRENT_VERSION"
          echo "  Release version for this build: $RELEASE_VERSION"

      - name: Run tests
        run: ./mvnw test

      - name: Build JAR
        run: ./mvnw clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-helloworld-db-jar-${{ github.sha }}
          path: target/*.jar
          retention-days: 30

  build-container:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-version: ${{ needs.build.outputs.release-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-helloworld-db-jar-${{ github.sha }}
          path: target/

      - name: Update JAR to use release version for container build
        run: |
          OLD_JAR=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          if [[ -f "$OLD_JAR" ]]; then
            NEW_JAR="target/${{ needs.build.outputs.artifact-id }}-${{ needs.build.outputs.release-version }}.jar"
            echo "Renaming JAR: $OLD_JAR -> $NEW_JAR"
            mv "$OLD_JAR" "$NEW_JAR"
            echo "‚úÖ JAR renamed to match release version"
          else
            echo "‚ùå Original JAR not found"
            exit 1
          fi

      - name: Set up Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build container image
        id: build
        run: |
          echo "üèóÔ∏è Building container image with release version ${{ needs.build.outputs.release-version }}..."
          podman build -t local-build .
          echo "Container image built successfully"

      - name: Tag images for release
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ needs.build.outputs.artifact-id }}
        run: |
          echo "üè∑Ô∏è Tagging images for release..."
          echo "Registry: $REGISTRY"
          echo "Image name: $IMAGE_NAME"
          echo "Release Version: ${{ needs.build.outputs.release-version }}"
          
          if [ -n "$REGISTRY" ] && [ "$REGISTRY" != "" ]; then
            CLEAN_REGISTRY=$(echo "$REGISTRY" | sed 's|^https\?://||' | sed 's|/$||')
            echo "Cleaned registry: $CLEAN_REGISTRY"
          
            if [[ "$CLEAN_REGISTRY" =~ ^[a-zA-Z0-9.-]+:[0-9]+$ ]] || [[ "$CLEAN_REGISTRY" =~ ^[a-zA-Z0-9.-]+$ ]]; then
              echo "Tagging with registry: $CLEAN_REGISTRY"
              podman tag local-build $CLEAN_REGISTRY/$IMAGE_NAME:${{ needs.build.outputs.release-version }}
              podman tag local-build $CLEAN_REGISTRY/$IMAGE_NAME:latest
            else
              echo "‚ùå Invalid registry format: $CLEAN_REGISTRY"
              exit 1
            fi
          else
            echo "No registry configured, using local tags"
            podman tag local-build $IMAGE_NAME:${{ needs.build.outputs.release-version }}
            podman tag local-build $IMAGE_NAME:latest
          fi
          
          echo "Tagged images:"
          podman images | grep $IMAGE_NAME

      - name: Login to Nexus Docker Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "üîê Logging into Nexus Docker registry..."
          CLEAN_REGISTRY=$(echo "${{ env.REGISTRY }}" | sed 's|^https\?://||' | sed 's|/$||')
          echo "Login registry: $CLEAN_REGISTRY"
          echo "${{ secrets.NEXUS_PASSWORD }}" | podman login \
            --username "${{ secrets.NEXUS_USERNAME }}" \
            --password-stdin \
            $CLEAN_REGISTRY

      - name: Push container images
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "üöÄ Pushing container images..."
          
          IMAGE_NAME="${{ needs.build.outputs.artifact-id }}"
          
          if [ -n "${{ env.REGISTRY }}" ]; then
            CLEAN_REGISTRY=$(echo "${{ env.REGISTRY }}" | sed 's|^https\?://||' | sed 's|/$||')
            echo "Push registry: $CLEAN_REGISTRY"
          
            podman push $CLEAN_REGISTRY/$IMAGE_NAME:${{ needs.build.outputs.release-version }}
            podman push $CLEAN_REGISTRY/$IMAGE_NAME:latest
          
            echo "‚úÖ Images pushed successfully:"
            echo "  - $CLEAN_REGISTRY/$IMAGE_NAME:${{ needs.build.outputs.release-version }}"
            echo "  - $CLEAN_REGISTRY/$IMAGE_NAME:latest"
          else
            echo "‚ö†Ô∏è No registry configured, skipping push"
          fi

  push-into-repository:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up JDK ${{ needs.build.outputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ needs.build.outputs.java-version }}
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-helloworld-db-jar-${{ github.sha }}
          path: target/

      - name: Configure Maven settings for Nexus
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>adeutschmanndev-nexus</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "‚úÖ Maven settings.xml configured successfully"

      - name: Deploy release to Nexus
        run: |
          chmod +x ./mvnw
          echo "üöÄ Pushing to Nexus repository..."
          echo "Project: ${{ needs.build.outputs.group-id }}:${{ needs.build.outputs.artifact-id }}:${{ needs.build.outputs.release-version }}"
          
          # Deploy as release version (not SNAPSHOT)
          REPO_URL="${{ secrets.NEXUS_URL }}/repository/maven-releases/"
          echo "üì¶ Pushing RELEASE to: $REPO_URL"
          
          JAR_FILE=$(find target -name "${{ needs.build.outputs.artifact-id }}-*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [[ ! -f "$JAR_FILE" ]]; then
            echo "‚ùå JAR file not found in target directory"
            echo "Looking for: target/${{ needs.build.outputs.artifact-id }}-*.jar"
            echo "Files in target directory:"
            ls -la target/
            exit 1
          fi
          
          echo "üì¶ Found JAR file: $JAR_FILE"
          
          ./mvnw deploy:deploy-file \
            -DgroupId=${{ needs.build.outputs.group-id }} \
            -DartifactId=${{ needs.build.outputs.artifact-id }} \
            -Dversion=${{ needs.build.outputs.release-version }} \
            -Dpackaging=jar \
            -Dfile="$JAR_FILE" \
            -DrepositoryId=adeutschmanndev-nexus \
            -Durl=$REPO_URL \
            -DgeneratePom=false \
            -DpomFile=pom.xml
          
          echo "‚úÖ Successfully deployed ${{ needs.build.outputs.group-id }}:${{ needs.build.outputs.artifact-id }}:${{ needs.build.outputs.release-version }} to: $REPO_URL"

      - name: Create Git tag for release
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v${{ needs.build.outputs.release-version }}" -m "Release version ${{ needs.build.outputs.release-version }}"
          git push origin "v${{ needs.build.outputs.release-version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload deployment summary
        if: always()
        run: |
          echo "## Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **POM Version**: ${{ needs.build.outputs.current-version }} (unchanged)" >> $GITHUB_STEP_SUMMARY
          echo "- **Released Version**: ${{ needs.build.outputs.release-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Java Version**: ${{ needs.build.outputs.java-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Maven Build**: $(if [ ${{ job.status }} == 'success' ]; then echo '‚úÖ Success'; else echo '‚ùå Failed'; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- **Nexus Deploy**: $(if [ ${{ job.status }} == 'success' ]; then echo '‚úÖ Deployed'; else echo '‚ùå Failed'; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag**: v${{ needs.build.outputs.release-version }}" >> $GITHUB_STEP_SUMMARY

  update-dev-overlay:
    runs-on: ubuntu-latest
    needs: build-container
    if: needs.build-container.result == 'success'
    steps:
      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          repository: adeutschmann-dev/spring-boot-hello-world-gitops
          token: ${{ secrets.CONFIG_REPO_TOKEN }}
          ref: main
          path: config-repo

      - name: Install yq
        run: sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && sudo chmod +x /usr/local/bin/yq

      - name: Update image tag in dev overlay
        env:
          TAG: ${{ needs.build-container.outputs.image-version }}
          IMAGE_NAME: ${{ needs.build.outputs.artifact-id }}
        run: |
          cd config-repo/environments/dev/hello-world-db
          yq -i '
            (.images[] | select(.name == "registry-nexus.apps.ocp4.adeutschmann.dev/" + env(IMAGE_NAME))).newTag = env(TAG)
          ' kustomization.yaml

      - name: Commit & push
        run: |
          cd config-repo
          git config user.name "ci-bot"
          git config user.email "ci@example.com"
          git add environments/dev/hello-world-db/kustomization.yaml
          git commit -m "Deploy dev: ${{ needs.build.outputs.artifact-id }}:${{ needs.build-container.outputs.image-version }}"
          git push

  build-and-deploy-migrations:
    runs-on: ubuntu-latest
    needs: update-dev-overlay
    if: needs.build-container.result == 'success'
    env:
      IMAGE_NAME: helloworld-db-migrations
      CONFIG_REPO: adeutschmann-dev/spring-boot-hello-world-gitops
      CONFIG_REPO_BRANCH: main
      CONFIG_REPO_PATH: environments/dev/hello-world-db
      FLYWAY_JOB_FILE: kustomization.yaml

    steps:
      - name: Checkout migrations repo
        uses: actions/checkout@v4

      - name: Compute TAG
        id: version
        run: |
          if [ -n "${GITHUB_REF_NAME##refs/tags/*}" ]; then
            TS=$(date -u +%Y%m%d-%H%M%S)
            echo "tag=${TS}-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF_NAME##refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Nexus registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NEXUS_DOCKER_REGISTRY }}
          username: ${{ secrets.NEXUS_USERNAME}}
          password: ${{ secrets.NEXUS_PASSWORD }}

      - name: Build & push migrations image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.flyway
          push: true
          tags: |
            ${{ secrets.NEXUS_DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}
            ${{ secrets.NEXUS_DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          provenance: false
          sbom: false

      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONFIG_REPO }}
          ref: ${{ env.CONFIG_REPO_BRANCH }}
          token: ${{ secrets.CONFIG_REPO_TOKEN }}
          path: config-repo

      - name: Install yq
        run: sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && sudo chmod +x /usr/local/bin/yq

      - name: Update flyway-job image tag
        env:
          FILE: config-repo/environments/dev/hello-world-db/kustomization.yaml
          IMAGE_BASE: registry-nexus.apps.ocp4.adeutschmann.dev/helloworld-db-migrations
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          echo "Updating $IMAGE_BASE to tag $TAG in $FILE"
          yq -i '
            (.images[] | select(.name == strenv(IMAGE_BASE)).newTag) = strenv(TAG)
          ' "$FILE"

      - name: Commit & push change
        working-directory: config-repo
        run: |
          git config user.name  "ci-bot"
          git config user.email "ci@example.com"
          git add "${CONFIG_REPO_PATH}/${FLYWAY_JOB_FILE}"
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "migrations: ${REGISTRY}/${IMAGE_NAME}:${{ steps.version.outputs.tag }}"
          git push

